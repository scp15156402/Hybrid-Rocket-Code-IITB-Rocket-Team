<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hybrid Motor Simulation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-left">
        <img src="{{ url_for('static', filename='iitb_logo.png') }}" alt="IITB Logo" class="logo">
        <span class="team-name">IITB Rocket Team</span>
      </div>
      <div class="header-right">
        <h1 class="app-title">Hybrid Motor Simulation</h1>
      </div>
    </header>

    <!-- RIBBON TOOLBAR -->
    <aside class="ribbon glass-panel" id="ribbon">
      <form method="POST">
        <div class="ribbon-header">
          <button type="submit" class="run-button" title="Run Simulation">Run</button>
          <nav class="ribbon-tabs">
            <button type="button" data-tab="tab1" class="active">Combustion</button>
            <button type="button" data-tab="tab2">Casing</button>
            <button type="button" data-tab="tab3">Nozzle</button>
            <button type="button" data-tab="tab4">Retainer</button>
            <button type="button" data-tab="tab5">Bolts</button>
            <button type="button" data-tab="tab6">Tank</button>
            <button type="button" data-tab="tab7">Materials</button>
          </nav>
        </div>

        <div class="ribbon-panels">
          {% for tab, keys in {
              'tab1': ["r1","r2","L","mdot_ox","rho_fuel"],
              'tab2': ["safety_factor","insul_grain_thk","insul_prepost_thk","casing_wall_thk","pre_comb_len","post_comb_len"],
              'tab3': ["converge_half_angle","throat_diameter","throat_length","diverge_half_angle"],
              'tab4': ["retainer_length","retainer_inner_radius","frontcap_length"],
              'tab5': ["frontcap_bolt_diameter","frontcap_num_bolts","nozzle_bolt_diameter","nozzle_num_bolts","ox_tank_bolt_diameter","ox_tank_num_bolts"],
              'tab6': ["ox_tank_safety_factor","ox_tank_outer_diameter","ox_tank_wall_thk","ox_tank_length","ox_tank_temp","ox_tank_frontcap_thk","ox_tank_backcap_thk"],
              'tab7': []
          }.items() %}
            <section id="{{ tab }}" class="ribbon-panel {% if loop.first %}active{% endif %}">
              {% for key in keys %}
                <div class="form-group">
                  <label for="{{key}}">{{ slider_config[key].label }}</label>
                  <input type="range" id="{{key}}" name="{{key}}"
                         min="{{slider_config[key].min}}" max="{{slider_config[key].max}}"
                         step="{{slider_config[key].step}}" value="{{current_values[key]}}"
                         oninput="document.getElementById('{{key}}_val').value = this.value">
                  <input type="number" id="{{key}}_val"
                         min="{{slider_config[key].min}}" max="{{slider_config[key].max}}"
                         step="{{slider_config[key].step}}" value="{{current_values[key]}}"
                         onchange="document.getElementById('{{key}}').value = this.value">
                </div>
              {% endfor %}
              {% if tab == 'tab6' %}
                <div class="form-group">
                  <label for="motor_ox_gap">{{ slider_config['motor_ox_gap'].label }}</label>
                  <input type="range" id="motor_ox_gap" name="motor_ox_gap"
                         min="{{ slider_config['motor_ox_gap'].min }}"
                         max="{{ slider_config['motor_ox_gap'].max }}"
                         step="{{ slider_config['motor_ox_gap'].step }}"
                         value="{{ current_values['motor_ox_gap'] }}"
                         oninput="document.getElementById('motor_ox_gap_val').value = this.value">
                  <input type="number" id="motor_ox_gap_val"
                         min="{{ slider_config['motor_ox_gap'].min }}"
                         max="{{ slider_config['motor_ox_gap'].max }}"
                         step="{{ slider_config['motor_ox_gap'].step }}"
                         value="{{ current_values['motor_ox_gap'] }}"
                         onchange="document.getElementById('motor_ox_gap').value = this.value">
                </div>
              {% endif %}
              {% if tab == 'tab7' %}
                {% for key, cfg in dropdown_config.items() %}
                  <div class="form-group">
                    <label for="{{key}}">{{ cfg.label }}</label>
                    <select id="{{key}}" name="{{key}}">
                      {% for opt in cfg.options %}
                        <option value="{{opt}}" {% if opt == current_values[key] %}selected{% endif %}>{{opt}}</option>
                      {% endfor %}
                    </select>
                  </div>
                {% endfor %}
              {% endif %}
            </section>
          {% endfor %}
        </div>

        <!-- Ribbon footer with collapse chevron -->
        <button type="button" id="collapse-btn" class="bottom-right-btn" onclick="toggleCollapse()" title="Collapse Ribbon">
  <i id="collapse-icon" class="bi bi-chevron-up"></i>
</button>

      </form>
    </aside>

    <!-- MAIN CONTENT BELOW RIBBON -->
    <div class="main-content-below-ribbon">

      <!-- TAB to expand panel when collapsed -->
      <div id="results-tab" class="results-tab">
        <i class="bi bi-chevron-up" title="Show Results"></i>
      </div>

      <!-- RESULTS PANEL -->
      <aside id="results-panel" class="results glass-panel">
        <div class="results-header">
          <span class="results-header-title">Simulation Results</span>
          <div class="results-controls">
            <i id="results-pin" class="bi bi-pin-angle-fill" title="Pin/Unpin Panel"></i>
            <i id="results-toggle" class="bi bi-chevron-down" title="Collapse/Expand Results"></i>
          </div>
        </div>

        {% if summary %}
          <div id="results-summary" class="results-summary">
            {% for section, metrics in summary.items() %}
              <section class="results-section">
                <h3 class="results-title">{{ section }}</h3>
                <ul class="results-list">
                  {% for label, value in metrics.items() %}
                    <li class="results-item">
                      <span class="label">{{ label }}</span>: <span class="value">{{ value }}</span>
                    </li>
                  {% endfor %}
                </ul>
              </section>
            {% endfor %}
          </div>
        {% else %}
          <div class="error-box">
            <h3 class="error-title">Simulation Failed</h3>
            <p class="error-message">No results to display.</p>
          </div>
        {% endif %}
      </aside>

      <!-- FIGURE CANVAS -->
      <main class="canvas">
        {% if plot_keys %}
          <h2 class="section-title">Figures</h2>
          {% for key in plot_keys %}
            <figure class="viz-figure glass-panel">
              <img src="{{ url_for('serve_plot', key=key) }}" alt="{{key}}">
              <figcaption>Figure {{ loop.index }}. {{ key|replace('_',' ')|title }}</figcaption>
            </figure>
          {% endfor %}
        {% endif %}
      </main>
    </div>
  </div>

  <!-- JS -->
  <script src="{{ url_for('static', filename='js/ribbon.js') }}"></script>
  <script src="{{ url_for('static', filename='js/results-panel.js') }}"></script>
</body>
</html>
